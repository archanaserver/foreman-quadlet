#!/usr/bin/env bash

RED=$(tput setaf 1 2>/dev/null)
GREEN=$(tput setaf 2 2>/dev/null)
RESET=$(tput sgr0 2>/dev/null)

EXIT_CODE=0

function success() {
    echo -e "\n${GREEN}[OK]${RESET}\n"
}

function error() {
    echo -e "\n${RED}[FAIL]${RESET}\n"
    CURRENT_EXIT_CODE=$1
    EXIT_CODE=$((EXIT_CODE|CURRENT_EXIT_CODE))
    echo -e "$2" >&2
}

function check-not-localhost() {
    printf "Checking that hostname is not 'localhost' or empty: "
    HOSTNAME=$(hostname)
    if [[ "$HOSTNAME" == "localhost" || "$HOSTNAME" == "localhost.localdomain" || -z "$HOSTNAME" ]]; then
        error 1 "Hostname is invalid: '$HOSTNAME'"
    else
        success
    fi
}

function check-fqdn-resolves() {
    printf "Checking that FQDN resolves via DNS or /etc/hosts: "
    FQDN=$(hostname -f)
    getent hosts "$FQDN" > /dev/null 2>&1
    if [[ $? -ne 0 ]]; then
        error 2 "FQDN '$FQDN' does not resolve"
    else
        success
    fi
}

function check-fqdn-has-dot() {
    printf "Checking that FQDN contains a dot: "
    FQDN=$(hostname -f)
    if [[ "$FQDN" != *.* ]]; then
        error 3 "FQDN '$FQDN' must contain at least one dot"
    else
        success
    fi
}

function check-fqdn-no-underscore() {
    printf "Checking that FQDN has no underscores: "
    FQDN=$(hostname -f)
    if [[ "$FQDN" == *"_"* ]]; then
        error 4 "FQDN '$FQDN' must not contain underscores"
    else
        success
    fi
}

function check-fqdn-lowercase() {
    printf "Checking that FQDN is all lowercase: "
    FQDN=$(hostname -f)
    if [[ "$FQDN" != "${FQDN,,}" ]]; then
        error 5 "FQDN '$FQDN' must be lowercase"
    else
        success
    fi
}

check-not-localhost
check-fqdn-resolves
check-fqdn-has-dot
check-fqdn-no-underscore
check-fqdn-lowercase

if [[ $EXIT_CODE == 0 ]]; then
    echo -e "${GREEN}Hostname validation succeeded${RESET}\n"
else
    exit $EXIT_CODE
fi
